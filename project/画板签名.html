<!DOCTYPE html>
<html lang="en">
<hebtn-allad>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç”»æ¿ç­¾å</title>
    <style>
        body {
            height: 100vh;
        }
        canvas {
            border: 2px solid #000;
            border-radius: 12px;
            margin: 50px auto 0;
        }
        input[name="line-width"] {
            width: 100px;
            border: 1px solid;
        }
        .btn-all {
            display: flex;
            justify-content: center;
            gap: 12px;
            margin-top: 20px;
        }
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            background-color: #fff;
            font-size: 16px;
            transition: all 0.3s;
            cursor: pointer;
        }
        .btn:hover {
            transform: scale(1.05);
        }
        .btn-clear {
            border: .5px solid #dcdee0;
        }
        .btn-ok {
            background-color: #1989fa;
            color: #fff;
        }
        .btn-downLoad {
            background-color: #07c160;
            color: #fff;
        }
    </style>
</hebtn-allad>
<body>
    <div style="display: flex;">
        <canvas width="600" height="400"></canvas>
    </div>

    <div class="btn-all">
        <label>è°ƒç¬”ç²—ç»†ï¼š</label><input type="text" name="line-width" id="">
        <label>è°ƒç¬”è‰²ï¼š</label><input type="color" value="#000"/>
    </div>
    <div class="btn-all btn-options">
        <button class="btn btn-clear">æ¸…ç©º</button>
        <button class="btn btn-ok">æŸ¥çœ‹å›¾ç‰‡</button>
        <button class="btn btn-downLoad">ä¸‹è½½å›¾ç‰‡</button>
    </div>
    <script>
        // ç»„ä»¶ä¸€èˆ¬ä¼šæŠ›å‡ºçš„è‡ªé€‰å€¼
        const props = {
            lineWidth: 3, // çº¿çš„ç²—ç»†
            penColor: '#000', // çº¿çš„è‰²å€¼
        };

        // ã€è¡¨å•å½•å…¥ã€‘å½•å…¥è°ƒç¬”çš„ç²—ç»†ã€è‰²å€¼ç­‰
        const lineSet = {
            lineWidthInput: document.querySelector('input[name="line-width"]'),
            colorInput: document.querySelector('input[type="color"]')
        };
        lineSet.lineWidthInput.addEventListener('input', (e) => {
            props.lineWidth = e.target.value || props.lineWidth;
        });
        lineSet.colorInput.addEventListener('input', (e) => {
            props.penColor = e.target.value || props.penColor;
        });

        // ã€ç”»å¸ƒğŸ¨ å’Œ ç”»ç¬”ğŸ–Œã€‘å°±ç»ª
        const canvas = document.querySelector('canvas');
        // è·å–2Dä¸Šä¸‹æ–‡ï¼ˆç”»ç¬”ğŸ–Œï¼‰
        const ctx = canvas.getContext('2d');
        console.log(ctx);

        // -----å…¬å…±æ–¹æ³•ï¼šç”»ä¸ªçº¿æ–¹æ³•-----
        function drawLine(xStart, yStart, xEnd, yEnd) {
            ctx.beginPath();
            ctx.moveTo(xStart, yStart);
            ctx.lineTo(xEnd, yEnd);
            ctx.stroke();
        }

        // -----å…¬å…±æ–¹æ³•ï¼šè®¡ç®—é¼ æ ‡/æ‰‹æŒ‡å½“å‰ ç›¸å¯¹äºcanvaså…ƒç´ çš„åæ ‡-----
        function getPosition(e) {
            // ç§»åŠ¨ç«¯çš„äº‹ä»¶é‡Œæ²¡æœ‰offsetX å’Œ offsetY
            // æ‰€ä»¥å¾— touch.clientX(å½“å‰æ‰‹æŒ‡åæ ‡è·ç¦»å±å¹•çš„è·ç¦») - rect.leftï¼ˆcanvaså…ƒç´ è·ç¦»å±å¹•çš„è·ç¦»ï¼‰ = å½“å‰æ‰‹æŒ‡åæ ‡åˆ°canvaså…ƒç´ çš„åæ ‡
            if (e.type.includes('touch')) {
                const touch = e.touches[0] || e.changedTouches[0];
                const rect = canvas.getBoundingClientRect();
                console.log('touch', touch);
                console.log('rect', rect);
                return [touch.clientX - rect.left, touch.clientY - rect.top];
            } else {
                return [e.offsetX, e.offsetY]
            }
        }

        // åˆå§‹è®°å½•äº›ä¸œè¥¿
        let startPoint = {x: '', y: ''};

        // ã€é¼ æ ‡/æ‰‹æŒ‡æŒ‰ä¸‹ã€‘è®°å½•èµ·å§‹åæ ‡
        function startDraw(e) {
            console.log('è®°å½•èµ·å§‹åæ ‡ => ', e);
            startPoint.x = getPosition(e)[0];
            startPoint.y = getPosition(e)[1];
            ctx.lineWidth = props.lineWidth;
            ctx.strokeStyle = props.penColor;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
        }
        canvas.addEventListener('mousedown', startDraw);
        canvas.addEventListener('touchstart', function(e) {
            e.preventDefault();
            startDraw(e)
        });

        // ã€é¼ æ ‡/æ‰‹æŒ‡ç§»åŠ¨ã€‘ï¼ï¼ï¼ æ¯æ¬¡ç§»åŠ¨ï¼Œéƒ½ç”»çº¿ã€‚ä¸å°±æ˜¯ä¸€ç›´åœ¨ç”»ç”»äº†å—
        function ingDraw(e) {
            if (!startPoint.x) {
                return
            };
            
            let newPoint = {
                x: getPosition(e)[0],
                y: getPosition(e)[1]
            };
            drawLine(startPoint.x, startPoint.y, newPoint.x, newPoint.y);
            startPoint = newPoint;
        }
        canvas.addEventListener('mousemove', ingDraw);
        canvas.addEventListener('touchmove', function(e) {
            e.preventDefault();
            ingDraw(e);
        });

        // ã€é¼ æ ‡/æ‰‹æŒ‡æŠ¬èµ·ã€‘
        function stopDrawing() {
            startPoint.x = '';
            startPoint.y = '';
        }
        canvas.addEventListener('mouseup', stopDrawing);
        canvas.addEventListener('touchEnd', function(e) {
            e.preventDefault();
            stopDrawing();
        });
        // ã€é¼ æ ‡ç§»å‡ºã€‘
        canvas.addEventListener('mouseout', stopDrawing);

        document.querySelector('.btn-clear').addEventListener('click', function() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        })

        // ã€ä¸šåŠ¡åŠŸèƒ½ã€‘æŸ¥çœ‹å›¾ç‰‡ã€‚æ ¸å¿ƒä»£ç canvas.toDataURL('image/png')å°†canvasè½¬ä¸ºå›¾ç‰‡
        const btnOk = document.querySelector('.btn-ok');
        btnOk.addEventListener('click', () => {
            const dataUrl = canvas.toDataURL('image/png');
            console.log('æ‰“å°ä¸‹å›¾ç‰‡ => ', dataUrl);
            const lll = document.createElement('div');
            lll.classList.add('img-con');
            lll.style.cssText = 'display: flex; justify-content: center; margin-top: 20px;';
            lll.innerHTML = `
                <div style="width: 150px; border: 1px solid green;">
                    <img style="width: 100%;" src="${dataUrl}"/>
                </div>
            `;
            document.querySelector('.btn-options').after(lll)
        })

        // ã€ä¸šåŠ¡åŠŸèƒ½ã€‘ä¸‹è½½å›¾ç‰‡ã€‚åˆ›å»ºaæ ‡ç­¾ï¼Œå°†hrefè®¾ç½®ä¸ºå›¾ç‰‡é“¾æ¥è§¦å‘ä¸‹è½½
        document.querySelector('.btn-downLoad').addEventListener('click', () => {
            const link = document.createElement('a');
            link.download = 'ç­¾å_' + new Date().toISOString().slice(0, 10) + '.png';
            link.href = canvas.toDataURL('image/png');
            link.click();
            document.body.removeChild(link);
        })
    </script>
</html>